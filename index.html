<!DOCTYPE html>
<html>
<head>â€¦</head>
<body>
   <!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
   <title>Stream Tester by Project Dev</title>
   <meta name="theme-color" content="#000000">
   <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96" />
   <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
   <link rel="shortcut icon" href="assets/favicon.ico" />
   <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png" />
   <meta name="apple-mobile-web-app-title" content="Stream Tester" />
   <link rel="manifest" href="assets/site.webmanifest" />
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.cdnfonts.com/css/general-sans" rel="stylesheet">
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/monaspace-font/neon.css">
   <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">
   <link href="https://fonts.googleapis.com/css2?family=Rethink+Sans:ital,wght@0,400..800;1,400..800&display=swap" rel="stylesheet">
   <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Text:wght@400;500;700&display=swap" rel="stylesheet">
   <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Code:wght@400;500;700&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
   <script src="https://unpkg.com/mux.js@5.10.0/dist/mux.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.16.9/dist/shaka-player.ui.min.js"></script>
   <link href="https://cdn.jsdelivr.net/npm/shaka-player@4.16.9/dist/controls.min.css" rel="stylesheet">
   <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
     <header class="header">
       <a href="/stream-tester">
         <img src="assets/stream_tester_logo.svg" alt="Stream Tester Logo" class="logo-img">
       </a>
       <button id="menu-toggle-btn" class="menu-button" aria-label="Open menu">
         <span class="material-symbols-rounded">menu</span>
       </button>
     </header>
    <main class="grid-container">
      <div class="player-wrapper">
        <div id="video-container" data-shaka-player-container>
          <video id="video" poster="assets/video_poster.svg" data-shaka-player autoplay></video>
        </div>
        <h2 id="channel-name-display">No Channel Loaded</h2>
      </div>

      <div class="card">
        <div class="input-mode-switcher">
            <button id="add-mode-btn" class="active">Playlist</button>
            <button id="manual-mode-btn">Manual</button>
        </div>
        <div id="add-mode-container">
            <h2>Load Playlist</h2>
            <div class="input-group">
                <label for="sourceSelector">Source</label>
                <div class="select-wrapper">
                  <select id="sourceSelector">
                      <option value="playlist" selected>Upload</option>
                      <option value="default">Samples</option>
                  </select>
                </div>
            </div>
            <div id="playlist-inputs">
                <div class="input-group">
                    <label for="m3uLink">Enter M3U Link or Upload File</label>
                    <div class="m3u-input-container">
                        <button id="upload-m3u-button" aria-label="Upload M3U file">
                            <span class="material-symbols-rounded">add</span>
                        </button>
                        <input type="text" id="m3uLink" placeholder="Paste M3U playlist URL here">
                        <input type="file" id="m3uFile" accept=".m3u,.m3u8" hidden>
                    </div>
                </div>
                <button id="loadPlaylistButton">Load Playlist</button>
            </div>
            <hr>
            <div class="input-group">
              <label for="channelSelector">Select Channel</label>
              <div class="select-wrapper">
                <select id="channelSelector">
                  <option value="">-- Select a source first --</option>
                </select>
              </div>
            </div>
        </div>
        <div id="manual-mode-container" style="display: none;">
            <h2>Manual Input</h2>
            <div class="input-group">
              <label for="manifestUri">Manifest URI</label>
              <input type="text" id="manifestUri" placeholder="Enter HLS or MPEG-DASH URI">
            </div>
            <div class="drm-fields" style="display: none;">
              <p style="font-size: 0.7rem; color: #888; margin-top: 1rem; margin-bottom: 0.5rem;">DRM (for MPEG-DASH only)</p>
              <div class="input-group">
                <label for="licenseTypeSelect">DRM Type</label>
                <div class="select-wrapper">
                  <select id="licenseTypeSelect">
                      <option value="com.widevine.alpha" selected>License URL (com.widevine.alpha)</option>
                      <option value="org.w3.clearkey">ClearKey (org.w3.clearkey)</option>
                  </select>
                </div>
              </div>
              <div id="license-url-container">
                  <div class="input-group">
                    <label for="licenseServerUrl">License Server URL</label>
                    <input type="text" id="licenseServerUrl" placeholder="Enter license server URL">
                  </div>
              </div>
              <div id="clearkey-container" style="display: none;">
                  <div class="input-group">
                    <label for="k1">Key ID (KID) in hex</label>
                    <input type="text" id="k1" placeholder="Enter Key ID (hex)">
                  </div>
                  <div class="input-group">
                    <label for="k2">Key in hex</label>
                    <input type="text" id="k2" placeholder="Enter Key (hex)">
                  </div>
              </div>
            </div>
            <button id="loadButton">Load Manual Input</button>
        </div>
        <div id="error-display"></div>
      </div>
    </main>
  </div>
  
  <nav id="floating-menu" class="floating-menu"></nav>

  <footer class="site-footer">
    <p>&copy; 2025 Project Dev. All Rights Reserved.</p>
    <p>Powered by Shaka Player (4.16.9)</p>
  </footer>
  <script src="js/script.js"></script>
</body>
</html>
   <script>
      let player;
let ui;
let playlistData = [];
let defaultStreamsData = {}; 

const video = document.getElementById('video');
const videoContainer = document.getElementById('video-container');
const errorDisplay = document.getElementById('error-display');
const manifestUriInput = document.getElementById('manifestUri');
const licenseServerUrlInput = document.getElementById('licenseServerUrl');
const licenseTypeSelect = document.getElementById('licenseTypeSelect');
const k1Input = document.getElementById('k1');
const k2Input = document.getElementById('k2');
const drmFieldsContainer = document.querySelector('.drm-fields');
const licenseUrlContainer = document.getElementById('license-url-container');
const clearkeyContainer = document.getElementById('clearkey-container');
const channelSelector = document.getElementById('channelSelector');
const channelNameDisplay = document.getElementById('channel-name-display');
const m3uLinkInput = document.getElementById('m3uLink');
const m3uFileInput = document.getElementById('m3uFile');
const uploadM3uButton = document.getElementById('upload-m3u-button');
const loadPlaylistButton = document.getElementById('loadPlaylistButton');
const loadManualButton = document.getElementById('loadButton');
const inputModeSwitcher = document.querySelector('.input-mode-switcher');
const addModeBtn = document.getElementById('add-mode-btn');
const manualModeBtn = document.getElementById('manual-mode-btn');
const addModeContainer = document.getElementById('add-mode-container');
const manualModeContainer = document.getElementById('manual-mode-container');
const sourceSelector = document.getElementById('sourceSelector');
const playlistInputs = document.getElementById('playlist-inputs');

const menuToggleBtn = document.getElementById('menu-toggle-btn');
const floatingMenu = document.getElementById('floating-menu');

const renderMenu = () => {
  const floatingMenu = document.getElementById('floating-menu');
  if (floatingMenu) {
    floatingMenu.innerHTML = `
    <ul>
        <li>
            <a href="/stream-tester/about">
                <span class="material-symbols-rounded">info</span>
                <span>About Us</span>
            </a>
        </li>
        <li>
            <a href="/stream-tester/how-to-use">
                <span class="material-symbols-rounded">help_center</span>
                <span>How to Use</span>
            </a>
        </li>
        <li>
            <a href="/stream-tester/feedback">
                <span class="material-symbols-rounded">feedback</span>
                <span>Feedback</span>
            </a>
        </li>
        <li>
            <a href="https://litestream-iptv.vercel.app/home">
                <span class="material-symbols-rounded">sensors</span>
                <span>Litestream</span>
            </a>
        </li>
    </ul>`;

    floatingMenu.querySelectorAll("li").forEach(item => {
      item.addEventListener("click", event => {
        const link = item.querySelector("a");
        if (link) {
          event.preventDefault();
          window.location.href = link.href;
        }
      });
      item.addEventListener("contextmenu", event => {
        event.preventDefault();
      });
    });
  }
};

function toggleDrmBlockVisibility() {
  const manifestUri = manifestUriInput.value.toLowerCase().trim();
  const isMpd = manifestUri.includes('.mpd');
  
  if (drmFieldsContainer) {
    drmFieldsContainer.style.display = isMpd ? 'block' : 'none';
  }
}

function updateDrmFieldVisibility() {
    const selectedType = licenseTypeSelect.value;
    const isWidevine = selectedType === 'com.widevine.alpha';
    const isNone = selectedType === 'none';

    if (licenseUrlContainer && clearkeyContainer) {
        licenseUrlContainer.style.display = isWidevine ? 'block' : 'none';
        clearkeyContainer.style.display = !isWidevine && !isNone ? 'block' : 'none';
    }
}

function handleRouting() {
  const redirectPath = sessionStorage.getItem('redirectPath');
  if (redirectPath) sessionStorage.removeItem('redirectPath');
  const currentPath = redirectPath || window.location.pathname;
  const pathSegments = currentPath.split('/').filter(Boolean);
  const isGitHubPages = window.location.hostname.includes('github.io');
  const effectivePath = isGitHubPages && pathSegments.length > 1 
    ? `/${pathSegments[pathSegments.length - 1]}` 
    : currentPath;

  if (effectivePath.toLowerCase().startsWith('/manual')) {
    switchInputMode('manual', false);
  } else {
    switchInputMode('playlist', false);
  }
}

function switchInputMode(mode, pushState = true) {
  const isPlaylist = mode === 'playlist';
  addModeContainer.style.display = isPlaylist ? 'block' : 'none';
  manualModeContainer.style.display = isPlaylist ? 'none' : 'block';
  addModeBtn.classList.toggle('active', isPlaylist);
  manualModeBtn.classList.toggle('active', !isPlaylist);
  updateSliderPosition();

  if (pushState) {
    const newRoute = isPlaylist ? 'playlist' : 'manual';
    const isGitHubPages = window.location.hostname.includes('github.io');
    const repoName = isGitHubPages ? `/${window.location.pathname.split('/')[1]}` : '';
    const finalPath = `${repoName}/${newRoute}`;
    if (window.location.pathname !== finalPath) {
      history.pushState({ mode: mode }, '', finalPath);
    }
  }
}

function initPlayer() {
  shaka.polyfill.installAll();
  if (shaka.Player.isBrowserSupported()) {
    player = new shaka.Player(video);
    ui = new shaka.ui.Overlay(player, videoContainer, video);
    player.addEventListener('error', onError);
  } else {
    showError('Your browser does not support Shaka Player.');
  }
}

async function loadStream(name) {
  const manifestUri = manifestUriInput.value.trim();
  const displayName = name || 'Manual Input';

  errorDisplay.style.display = 'none';
  if (!manifestUri) return alert('Manifest URI is required.');
  
  channelNameDisplay.textContent = `Loading: ${displayName}...`;

  const config = { drm: {} };
  const selectedDrmType = licenseTypeSelect.value;

  if (drmFieldsContainer.style.display === 'block' && selectedDrmType !== 'none') {
    if (selectedDrmType === 'com.widevine.alpha') {
      const licenseServerUrl = licenseServerUrlInput.value.trim();
      if (licenseServerUrl) {
        config.drm.servers = { [selectedDrmType]: licenseServerUrl };
      }
    } else if (selectedDrmType === 'org.w3.clearkey') {
      const kid = k1Input.value.trim();
      const key = k2Input.value.trim();
      if (kid && key) {
        config.drm.clearKeys = { [kid]: key };
      }
    }
  }
  
  player.configure(config);

  try {
    await player.load(manifestUri);
    channelNameDisplay.textContent = displayName;
  } catch (e) {
    onError({ detail: e });
    channelNameDisplay.textContent = `Failed to load: ${displayName}`;
  }
}

async function fetchDefaultStreams() {
    try {
        const response = await fetch('js/getChannels.js');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        defaultStreamsData = await response.json();
        if (sourceSelector && sourceSelector.value === 'default') {
            populateDefaultChannels();
        }
    } catch (e) {
        showError(`Failed to load default streams: ${e.message}`);
    }
}

async function handlePlaylistLoad() {
  let m3uData = '';
  errorDisplay.style.display = 'none';
  const file = m3uFileInput.files[0];
  const link = m3uLinkInput.value.trim();

  try {
    if (link) {
      const response = await fetch(link);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      m3uData = await response.text();
    } else if (file) {
      m3uData = await file.text();
    } else {
      return alert('Please enter an M3U link or upload a file first.');
    }
    playlistData = parseM3U(m3uData);
    populatePlaylistChannels();
  } catch (e) {
    showError(`Failed to load playlist: ${e.message}`);
  }
}

function base64UrlToHex(base64Url) {
  try {
    let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    while (base64.length % 4) {
      base64 += '=';
    }
    const raw = atob(base64);
    let hex = '';
    for (let i = 0; i < raw.length; i++) {
      hex += raw.charCodeAt(i).toString(16).padStart(2, '0');
    }
    return hex;
  } catch (e) {
    console.error('Failed to decode base64 string:', base64Url, e);
    return null;
  }
}

function parseM3U(data) {
  const lines = data.split('\n');
  const channels = [];
  let currentChannel = {};
  for (const line of lines) {
    const trimmedLine = line.trim();
    if (trimmedLine.startsWith('#EXTINF:')) {
      const info = trimmedLine.split(/,(.*)/s);
      currentChannel.name = info[1]?.trim() || 'Unknown Channel';
    } else if (trimmedLine.startsWith('#KODIPROP:inputstream.adaptive.license_type=')) {
      const type = trimmedLine.split('=')[1]?.trim();
      if (type.toLowerCase() === 'clearkey') {
        currentChannel.licenseType = 'org.w3.clearkey';
      } else {
        currentChannel.licenseType = type;
      }
    } else if (trimmedLine.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
      const keyData = trimmedLine.split('=').slice(1).join('=');
      
      if (keyData.trim().startsWith('{')) {
        try {
          const parsedJson = JSON.parse(keyData);
          if (parsedJson.keys && parsedJson.keys.length > 0) {
            const keyInfo = parsedJson.keys[0];
            if (keyInfo.k && keyInfo.kid) {
              currentChannel.k2 = base64UrlToHex(keyInfo.k);
              currentChannel.k1 = base64UrlToHex(keyInfo.kid);
              currentChannel.licenseType = 'org.w3.clearkey';
            }
          }
        } catch (e) {
          console.error('Failed to parse license_key JSON:', keyData, e);
        }
      }
      else if (keyData.includes('http://') || keyData.includes('https://')) {
        currentChannel.licenseKey = keyData.trim();
      } 
      else {
        const keyParts = keyData.split(':');
        if (keyParts.length === 2 && keyParts[0].trim() && keyParts[1].trim()) {
          currentChannel.k1 = keyParts[0].trim();
          currentChannel.k2 = keyParts[1].trim();
        }
      }
    } else if (trimmedLine && !trimmedLine.startsWith('#')) {
      currentChannel.url = trimmedLine;
      channels.push(currentChannel);
      currentChannel = {};
    }
  }
  return channels;
}

function populatePlaylistChannels() {
  channelSelector.innerHTML = '<option value="">-- Select a channel --</option>';
  if (playlistData.length > 0) {
    playlistData.forEach((channel, index) => {
      const option = new Option(channel.name, `playlist_${index}`);
      channelSelector.appendChild(option);
    });
    alert(`${playlistData.length} channels loaded. Please select one.`);
  } else {
    alert('No channels found or playlist is empty.');
  }
  
  m3uFileInput.value = '';
}

function populateDefaultChannels() {
    channelSelector.innerHTML = '<option value="">-- Select a Sample Stream --</option>';
    Object.keys(defaultStreamsData).forEach(channelKey => {
        const displayName = channelKey.replace(/_/g, ' '); 
        const option = new Option(displayName, `default_${channelKey}`);
        channelSelector.appendChild(option);
    });
}

function onChannelSelect(event) {
  const selectedValue = event.target.value;
  if (!selectedValue) return;

  let channel;
  let displayName;

  if (selectedValue.startsWith('playlist_')) {
      const m3uIndex = parseInt(selectedValue.substring(9), 10);
      channel = playlistData[m3uIndex];
      displayName = channel.name;
  } else if (selectedValue.startsWith('default_')) {
      const streamKey = selectedValue.substring(8);
      channel = defaultStreamsData[streamKey];
      displayName = streamKey.replace(/_/g, ' ');
  }

  if (channel) {
    manifestUriInput.value = channel.url || '';
    
    if ((channel.licenseType === 'org.w3.clearkey' || (channel.k1 && channel.k2)) && channel.k1 && channel.k2) {
        licenseTypeSelect.value = 'org.w3.clearkey';
        k1Input.value = channel.k1;
        k2Input.value = channel.k2;
        licenseServerUrlInput.value = '';
    } else if (channel.licenseType && channel.licenseKey) {
        licenseTypeSelect.value = channel.licenseType;
        licenseServerUrlInput.value = channel.licenseKey;
        k1Input.value = '';
        k2Input.value = '';
    } else {
        licenseTypeSelect.value = 'none';
        licenseServerUrlInput.value = '';
        k1Input.value = '';
        k2Input.value = '';
    }
    
    toggleDrmBlockVisibility();
    updateDrmFieldVisibility(); 
    loadStream(displayName);
  }
}

function handleSourceChange(event) {
    const selectedSource = event.target.value;
    channelSelector.innerHTML = '<option value="">-- Select a source first --</option>';
    if (selectedSource === 'default') {
        playlistInputs.style.display = 'none'; 
        populateDefaultChannels();
    } else { 
        playlistInputs.style.display = 'block';
        if (playlistData.length > 0) populatePlaylistChannels();
    }
}

function updateSliderPosition() {
  const activeButton = inputModeSwitcher.querySelector('button.active');
  if (activeButton) {
    inputModeSwitcher.style.setProperty('--slider-left', `${activeButton.offsetLeft}px`);
    inputModeSwitcher.style.setProperty('--slider-width', `${activeButton.offsetWidth}px`);
  }
}

function showError(message) {
  console.error(message);
  errorDisplay.textContent = message;
  errorDisplay.style.display = 'block';
}

function onError(event) {
  const error = event.detail;
  console.error('Shaka Player Error:', error);
  showError(`Error Code: ${error.code}\nCategory: ${error.category}`);
}

function toggleMenu() {
    const floatingMenu = document.getElementById('floating-menu');
    if (floatingMenu) {
        floatingMenu.classList.toggle('active');
    }
}

function setupPlayerEventListeners() {
  uploadM3uButton.addEventListener('click', () => m3uFileInput.click());
  loadPlaylistButton.addEventListener('click', handlePlaylistLoad);
  loadManualButton.addEventListener('click', () => loadStream());
  channelSelector.addEventListener('change', onChannelSelect);
  addModeBtn.addEventListener('click', () => switchInputMode('playlist'));
  manualModeBtn.addEventListener('click', () => switchInputMode('manual'));
  window.addEventListener('resize', updateSliderPosition);
  window.addEventListener('popstate', handleRouting);
  manifestUriInput.addEventListener('input', toggleDrmBlockVisibility);
  licenseTypeSelect.addEventListener('change', updateDrmFieldVisibility);
  m3uFileInput.addEventListener('change', handlePlaylistLoad);
  
  if (sourceSelector) {
    sourceSelector.addEventListener('change', handleSourceChange);
  }

  if (menuToggleBtn && floatingMenu) {
      menuToggleBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          toggleMenu();
      });
      window.addEventListener('click', (event) => {
          if (floatingMenu.classList.contains('active') && !floatingMenu.contains(event.target)) {
              toggleMenu();
          }
      });
  }
}

function setupStaticPageHandlers() {
    const interactiveElements = document.querySelectorAll(
        '.back-button, .feedback-link, .social-icon-links a, .developer-section a'
    );

    if (interactiveElements.length > 0) {
        interactiveElements.forEach(el => {
            el.addEventListener('contextmenu', event => event.preventDefault());
        });
    }
}

function main() {
  setupStaticPageHandlers();

  if (document.getElementById('video-container')) {
    setupPlayerEventListeners();
    handleRouting(); 
    initPlayer();
    fetchDefaultStreams(); 
    toggleDrmBlockVisibility(); 
    updateDrmFieldVisibility();
    renderMenu();
  }
}

document.addEventListener('DOMContentLoaded', main);
   </script>
</body>
</html>
